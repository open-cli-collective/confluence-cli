name: Test Winget Manifest

on:
  pull_request:
    paths:
      - 'packaging/winget/**'
      - '.github/workflows/test-winget.yml'
  push:
    branches: [main]
    paths:
      - 'packaging/winget/**'
      - '.github/workflows/test-winget.yml'

jobs:
  test-winget:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build binary for testing
        run: go build -o cfl.exe ./cmd/cfl

      - name: Create test zip package
        shell: pwsh
        run: |
          Compress-Archive -Path cfl.exe, LICENSE, README.md -DestinationPath cfl_0.0.1_windows_amd64.zip
          $hash = (Get-FileHash cfl_0.0.1_windows_amd64.zip -Algorithm SHA256).Hash
          Write-Host "SHA256: $hash"
          $localUrl = "file:///$($pwd.Path -replace '\\','/')/cfl_0.0.1_windows_amd64.zip"
          Write-Host "Local URL: $localUrl"
          echo "HASH=$hash" >> $env:GITHUB_ENV
          echo "LOCAL_URL=$localUrl" >> $env:GITHUB_ENV

      - name: Generate test manifests
        shell: pwsh
        run: |
          $hash = $env:HASH
          $localUrl = $env:LOCAL_URL

          # Version manifest
          Set-Content packaging/winget/OpenCLICollective.cfl.yaml -Encoding UTF8 @(
            'PackageIdentifier: OpenCLICollective.cfl'
            'PackageVersion: 0.0.1'
            'DefaultLocale: en-US'
            'ManifestType: version'
            'ManifestVersion: 1.6.0'
          )

          # Locale manifest
          Set-Content packaging/winget/OpenCLICollective.cfl.locale.en-US.yaml -Encoding UTF8 @(
            'PackageIdentifier: OpenCLICollective.cfl'
            'PackageVersion: 0.0.1'
            'PackageLocale: en-US'
            'Publisher: Open CLI Collective'
            'PublisherUrl: https://github.com/open-cli-collective'
            'PackageName: Confluence CLI'
            'PackageUrl: https://github.com/open-cli-collective/confluence-cli'
            'License: MIT'
            'LicenseUrl: https://github.com/open-cli-collective/confluence-cli/blob/main/LICENSE'
            'ShortDescription: Command-line interface for Atlassian Confluence Cloud'
            'ManifestType: defaultLocale'
            'ManifestVersion: 1.6.0'
          )

          # Installer manifest
          Set-Content packaging/winget/OpenCLICollective.cfl.installer.yaml -Encoding UTF8 @(
            'PackageIdentifier: OpenCLICollective.cfl'
            'PackageVersion: 0.0.1'
            'InstallerType: zip'
            'NestedInstallerType: portable'
            'NestedInstallerFiles:'
            '  - RelativeFilePath: cfl.exe'
            '    PortableCommandAlias: cfl'
            'Installers:'
            '  - Architecture: x64'
            "    InstallerUrl: $localUrl"
            "    InstallerSha256: $hash"
            'ManifestType: installer'
            'ManifestVersion: 1.6.0'
          )

          Write-Host "Generated installer manifest:"
          Get-Content packaging/winget/OpenCLICollective.cfl.installer.yaml

      - name: Validate manifests
        shell: pwsh
        run: |
          Write-Host "Validating Winget manifests..."
          winget validate --manifest packaging/winget/
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Manifest validation failed"
            exit 1
          }
          Write-Host "Manifest validation passed!"

      - name: Install from local manifest
        shell: pwsh
        run: |
          Write-Host "Installing from local manifest..."
          winget install --manifest packaging/winget/ --accept-package-agreements --accept-source-agreements
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Installation failed"
            exit 1
          }

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "Testing cfl --version..."
          cfl --version
          if ($LASTEXITCODE -ne 0) {
            Write-Error "cfl --version failed"
            exit 1
          }
          Write-Host "cfl is working!"

      - name: Test uninstall
        shell: pwsh
        run: |
          winget uninstall OpenCLICollective.cfl --accept-source-agreements
          Write-Host "Uninstall completed"
