name: Publish to Winget

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.9.9)'
        required: true
        type: string

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Install wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Validate release exists
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $release = gh release view "v${{ inputs.version }}" --repo open-cli-collective/confluence-cli --json tagName 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Release v${{ inputs.version }} not found"
            exit 1
          }
          Write-Host "Found release v${{ inputs.version }}"

      - name: Submit to Winget
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $x64 = "https://github.com/open-cli-collective/confluence-cli/releases/download/v$version/cfl_${version}_windows_amd64.zip"
          $arm64 = "https://github.com/open-cli-collective/confluence-cli/releases/download/v$version/cfl_${version}_windows_arm64.zip"

          Write-Host "Submitting version $version to Winget"
          Write-Host "x64 URL: $x64"
          Write-Host "arm64 URL: $arm64"

          ./wingetcreate.exe update OpenCLICollective.cfl --version $version --urls $x64 $arm64 --submit --token ${{ secrets.WINGET_GITHUB_TOKEN }}
